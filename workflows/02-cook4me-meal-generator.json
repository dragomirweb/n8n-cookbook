{
  "name": "Cook4me Meal Generator - Sub-Workflow",
  "nodes": [
    {
      "parameters": {},
      "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "name": "Workflow Input",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Validate required inputs\nconst requiredFields = ['user_id', 'user_profile', 'message_text'];\nconst missing = [];\n\nrequiredFields.forEach(field => {\n    if (!$json[field]) {\n        missing.push(field);\n    }\n});\n\nif (missing.length > 0) {\n    throw new Error(`Missing required fields: ${missing.join(', ')}`);\n}\n\nreturn [{\n    json: {\n        ...$json,\n        workflow_start: new Date().toISOString()\n    }\n}];"
      },
      "id": "b2c3d4e5-f678-9012-3456-789012345678",
      "name": "Validate Inputs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// CRITICAL: Check meal cache before expensive AI call\n// This can save 90% of costs for repeated requests\n\nconst userProfile = $json.user_profile;\n\n// Create deterministic cache key from preferences\nconst cacheKeyData = {\n    protein: userProfile.preferred_proteins || ['chicken'],\n    restrictions: userProfile.dietary_restrictions || [],\n    calories: userProfile.daily_calorie_target || 2300,\n    cooking_method: 'cook4me'\n};\n\n// Simple hash function for cache key\nfunction simpleHash(obj) {\n    const str = JSON.stringify(obj);\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n        const char = str.charCodeAt(i);\n        hash = ((hash << 5) - hash) + char;\n        hash = hash & hash;\n    }\n    return hash.toString(36);\n}\n\nconst cacheKey = `meal:cook4me:${simpleHash(cacheKeyData)}`;\n\n// In production: const cached = await $redis.get(cacheKey)\nconst cached = null; // Simulated for now\n\nif (cached) {\n    const meal = JSON.parse(cached);\n    \n    return [{\n        json: {\n            ...$json,\n            cache_hit: true,\n            meal: meal,\n            note: 'âœ¨ Curated meal from your preferences',\n            cost_usd: 0,\n            response_time_ms: 50\n        }\n    }];\n}\n\nreturn [{\n    json: {\n        ...$json,\n        cache_hit: false,\n        cache_key: cacheKey,\n        cache_check_completed: true\n    }\n}];"
      },
      "id": "c3d4e5f6-7890-1234-5678-901234567890",
      "name": "Check Meal Cache",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        680,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.cache_hit}}",
              "value2": true
            }
          ]
        }
      },
      "id": "d4e5f678-9012-3456-7890-123456789012",
      "name": "Is Cache Hit?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// CRITICAL: Build Anthropic request with prompt caching\n// This reduces costs by 90% on cached portions\n\nconst userProfile = $json.user_profile;\nconst messageText = $json.message_text;\n\n// System prompt (2000+ tokens - CACHED for 5 minutes)\nconst SYSTEM_PROMPT = `You are an expert nutritionist and Cook4me pressure cooker specialist with 15 years of experience in OMAD (One Meal A Day) nutrition planning.\n\n# YOUR ROLE\n- Create nutritionally complete, accurate OMAD meals optimized for the Cook4me pressure cooker\n- Ensure 100% compliance with Cook4me cooking requirements\n- Provide restaurant-quality recipes with precise nutritional data\n- All nutritional values MUST be verified against USDA FoodData Central\n\n# COOK4ME PRESSURE COOKER REQUIREMENTS (MANDATORY)\n\n## Critical Safety & Format Rules:\n1. **Minimum 200ml liquid** - Pressure cookers require liquid to build pressure\n2. **Lid Status** - Explicitly state when lid is open vs. closed/locked\n3. **Pressure Cooking Time Format** - MUST include exact phrase: \"Pressure cooking time = X min\"\n4. **No Overfilling** - Maximum 2/3 capacity (account for expansion)\n5. **Natural Release** - Specify if quick or natural pressure release\n\n## Cook4me Recipe Structure (STRICT FORMAT):\n1. \"Prepare the ingredients:\" [detailed prep list with weights]\n2. \"Pre-heat your Cook4Me pot and add [X]ml oil\" (lid OPEN)\n3. \"Brown [ingredients] for 2-3 minutes\" (lid OPEN, browning mode)\n4. \"Add remaining ingredients. Stir well to combine\"\n5. \"Close and lock the lid\"\n6. \"Pressure cooking time = [X] min\" (EXACT format required)\n7. Post-cooking steps: \"Open lid, stir, season to taste\"\n\n## Timing Guidelines:\n- Chicken (cubed): 12-15 minutes under pressure\n- Beef (cubed): 20-25 minutes under pressure\n- Rice (with liquid 1:1.5 ratio): 10-12 minutes\n- Vegetables (added after meat): 3-5 minutes\n- Total recipe time: ~1/3 of traditional cooking time\n\n# NUTRITIONAL REQUIREMENTS\n\n## OMAD Target (37-year-old, 97kg male):\n- **Calories**: 2300 Â± 115 kcal (2185-2415 acceptable range)\n- **Protein**: 130-160g (chicken preferred, ~40g per 100g raw chicken)\n- **Carbohydrates**: 230-280g (complex carbs prioritized)\n- **Fat**: 70-90g (healthy fats preferred)\n- **Fiber**: 30g minimum (digestive health)\n- **Sodium**: <2300mg (blood pressure management)\n\n## Macronutrient Distribution:\n- Protein: 22-25% of calories (4 cal/g)\n- Carbs: 45-50% of calories (4 cal/g)\n- Fat: 28-32% of calories (9 cal/g)\n\n## Ingredient Weight Calculations:\n**CRITICAL**: All weights are for PREPARED ingredients (post-peeling, dicing, draining)\n\n### Chicken Nutrition (per 100g raw):\n- Chicken Breast (skinless): 165 cal, 31g protein, 0g carbs, 3.6g fat\n- Chicken Thigh (skinless): 209 cal, 26g protein, 0g carbs, 11g fat\n- Cooking loss: -25% weight (use raw weight in recipe)\n\n### Common Cooking Weights:\n- Rice: Uncooked weight (triples when cooked)\n- Pasta: Uncooked weight (doubles when cooked)\n- Vegetables: After peeling/trimming\n- Canned goods: Drained weight\n\n# RESPONSE FORMAT\n\nYou MUST respond with valid JSON only. No markdown, no explanations outside JSON.\n\n{\n  \"meal_name\": \"Descriptive name (e.g., 'Pressure Cooker Chicken & Rice Bowl')\",\n  \"description\": \"1-2 sentence appetizing description\",\n  \"prep_time_minutes\": number,\n  \"cook_time_minutes\": number,\n  \"servings\": 1,\n  \"ingredients\": [\n    {\n      \"item\": \"chicken breast\",\n      \"quantity\": 300,\n      \"unit\": \"g\",\n      \"preparation\": \"diced into 2cm pieces\",\n      \"calories\": 495,\n      \"protein_g\": 93,\n      \"carbs_g\": 0,\n      \"fat_g\": 11,\n      \"fiber_g\": 0,\n      \"usda_source\": \"FDC ID: 171477\"\n    }\n  ],\n  \"instructions\": [\n    {\"step\": 1, \"instruction\": \"Prepare ingredients: [detailed list]\", \"timing\": null},\n    {\"step\": 2, \"instruction\": \"Pre-heat your Cook4Me pot and add 15ml olive oil\", \"timing\": \"1 min\"},\n    {\"step\": 3, \"instruction\": \"Brown chicken pieces for 2-3 minutes until golden\", \"timing\": \"3 min\"},\n    {\"step\": 4, \"instruction\": \"Add rice, vegetables, water, and seasonings. Stir well to combine\", \"timing\": \"1 min\"},\n    {\"step\": 5, \"instruction\": \"Close and lock the lid\", \"timing\": null},\n    {\"step\": 6, \"instruction\": \"Pressure cooking time = 15 min\", \"timing\": \"15 min\"},\n    {\"step\": 7, \"instruction\": \"Allow natural pressure release for 5 minutes, then quick release\", \"timing\": \"5 min\"},\n    {\"step\": 8, \"instruction\": \"Open lid, fluff rice, season with salt and pepper to taste\", \"timing\": \"1 min\"}\n  ],\n  \"cooking_method\": \"cook4me\",\n  \"cuisine_type\": \"Asian\",\n  \"difficulty_level\": \"easy\",\n  \"nutritional_summary\": {\n    \"total_calories\": 2285,\n    \"total_protein_g\": 145.5,\n    \"total_carbs_g\": 255.0,\n    \"total_fat_g\": 72.0,\n    \"total_fiber_g\": 35.0,\n    \"total_sodium_mg\": 1850\n  },\n  \"calculation_reasoning\": \"Chicken breast 300g = 495 cal (165*3), Rice 150g uncooked = 540 cal (360*1.5)...\",\n  \"data_sources\": \"USDA FoodData Central IDs: 171477 (chicken), 168878 (rice)...\"\n}\n\n# VALIDATION CHECKLIST (Self-check before responding):\n- [ ] Total calories 2185-2415 kcal?\n- [ ] Protein 130-160g?\n- [ ] Carbs 230-280g?\n- [ ] Fat 70-90g?\n- [ ] Fiber â‰¥30g?\n- [ ] Includes \"Pressure cooking time = X min\"?\n- [ ] Minimum 200ml liquid?\n- [ ] All ingredients have nutritional data?\n- [ ] Calculations shown and correct?\n- [ ] Valid JSON format?\n\nIf any check fails, regenerate the meal before responding.`;\n\n// User profile context (500 tokens - CACHED)\nconst profileContext = JSON.stringify({\n    age: userProfile.age || 37,\n    weight_kg: userProfile.weight_kg || 97,\n    daily_calorie_target: userProfile.daily_calorie_target || 2300,\n    daily_protein_target_g: userProfile.daily_protein_target_g || 130,\n    daily_carbs_target_g: userProfile.daily_carbs_target_g || 250,\n    daily_fat_target_g: userProfile.daily_fat_target_g || 75,\n    dietary_restrictions: userProfile.dietary_restrictions || [],\n    preferred_proteins: userProfile.preferred_proteins || ['chicken'],\n    allergens: userProfile.allergens || [],\n    disliked_foods: userProfile.disliked_foods || []\n}, null, 2);\n\n// Build Anthropic API request\nconst request = {\n    model: \"claude-sonnet-4-5-20250120\",\n    max_tokens: 2500,\n    temperature: 0.4,\n    system: [\n        {\n            type: \"text\",\n            text: SYSTEM_PROMPT,\n            cache_control: { type: \"ephemeral\" } // CACHED for 5 min\n        },\n        {\n            type: \"text\",\n            text: `User Profile:\\n${profileContext}`,\n            cache_control: { type: \"ephemeral\" } // CACHED for 5 min\n        }\n    ],\n    messages: [\n        {\n            role: \"user\",\n            content: `Generate a complete OMAD Cook4me meal.\\n\\nUser Request: \"${messageText}\"\\n\\nSpecial Instructions:\\n- Use chicken as primary protein\\n- Include variety of colorful vegetables\\n- Ensure meal is filling and satisfying\\n\\nGenerate a nutritionally complete meal following all requirements above.`\n        }\n    ]\n};\n\nreturn [{\n    json: {\n        ...$json,\n        anthropic_request: request,\n        prompt_built: true\n    }\n}];"
      },
      "id": "e5f67890-1234-5678-9012-345678901234",
      "name": "Build AI Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        200
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "={{$env.ANTHROPIC_API_KEY}}"
            },
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{JSON.stringify($json.anthropic_request)}}",
        "options": {
          "timeout": 60000,
          "retry": {
            "maxRetries": 3,
            "retryOnHttpStatusCodes": "429,500,502,503,504"
          }
        }
      },
      "id": "f6789012-3456-7890-1234-567890123456",
      "name": "Call Anthropic API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1340,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse and validate Anthropic response\nconst response = $input.first().json;\nconst previousData = $('Build AI Prompt').first().json;\n\n// Extract AI response\nconst content = response.content[0].text;\n\nlet meal;\ntry {\n    meal = JSON.parse(content);\n} catch (error) {\n    throw new Error(`Failed to parse AI response as JSON: ${error.message}\\n\\nResponse: ${content.substring(0, 500)}...`);\n}\n\n// Track usage and costs\nconst usage = {\n    provider: 'anthropic',\n    model: response.model,\n    input_tokens: response.usage.input_tokens,\n    output_tokens: response.usage.output_tokens,\n    cache_read_tokens: response.usage.cache_read_input_tokens || 0,\n    cache_creation_tokens: response.usage.cache_creation_input_tokens || 0\n};\n\n// Calculate costs (January 2025 pricing)\nusage.input_cost_usd = (usage.input_tokens / 1000) * 0.003;\nusage.output_cost_usd = (usage.output_tokens / 1000) * 0.015;\nusage.cache_read_cost_usd = (usage.cache_read_tokens / 1000) * 0.0003;\nusage.cache_write_cost_usd = (usage.cache_creation_tokens / 1000) * 0.00375;\nusage.total_cost_usd = usage.input_cost_usd + usage.output_cost_usd + usage.cache_read_cost_usd + usage.cache_write_cost_usd;\n\n// Cache hit rate\nconst total_input = usage.input_tokens + usage.cache_read_tokens;\nusage.cache_hit_rate = total_input > 0 ? ((usage.cache_read_tokens / total_input) * 100).toFixed(2) : 0;\n\nreturn [{\n    json: {\n        ...previousData,\n        meal: meal,\n        usage: usage,\n        ai_response_parsed: true\n    }\n}];"
      },
      "id": "67890123-4567-8901-2345-678901234567",
      "name": "Parse AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1560,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// CRITICAL: Strict nutritional validation\n// Invalid meals could harm users - this is non-negotiable\n\nconst meal = $json.meal;\nconst errors = [];\nconst warnings = [];\n\n// Required fields validation\nconst required = [\n    'meal_name', 'ingredients', 'instructions',\n    'nutritional_summary', 'cooking_method'\n];\n\nrequired.forEach(field => {\n    if (!meal[field]) {\n        errors.push(`Missing required field: ${field}`);\n    }\n});\n\n// Nutritional validation\nconst nutrition = meal.nutritional_summary;\n\nif (nutrition) {\n    // Calories (Â±5% tolerance)\n    const targetCalories = 2300;\n    const calorieMin = 2185;\n    const calorieMax = 2415;\n    \n    if (nutrition.total_calories < calorieMin || nutrition.total_calories > calorieMax) {\n        errors.push(`Calories out of range: ${nutrition.total_calories} (expected ${calorieMin}-${calorieMax})`);\n    }\n    \n    // Protein\n    if (nutrition.total_protein_g < 130) {\n        errors.push(`Protein too low: ${nutrition.total_protein_g}g (minimum 130g)`);\n    }\n    if (nutrition.total_protein_g > 160) {\n        warnings.push(`Protein high: ${nutrition.total_protein_g}g (target 130-160g)`);\n    }\n    \n    // Carbs\n    if (nutrition.total_carbs_g < 230) {\n        warnings.push(`Carbs low: ${nutrition.total_carbs_g}g (target 230-280g)`);\n    }\n    if (nutrition.total_carbs_g > 280) {\n        warnings.push(`Carbs high: ${nutrition.total_carbs_g}g (target 230-280g)`);\n    }\n    \n    // Fat\n    if (nutrition.total_fat_g < 70) {\n        warnings.push(`Fat low: ${nutrition.total_fat_g}g (target 70-90g)`);\n    }\n    if (nutrition.total_fat_g > 90) {\n        warnings.push(`Fat high: ${nutrition.total_fat_g}g (target 70-90g)`);\n    }\n    \n    // Fiber\n    if (nutrition.total_fiber_g < 30) {\n        warnings.push(`Fiber low: ${nutrition.total_fiber_g}g (minimum 30g recommended)`);\n    }\n}\n\n// Cook4me format validation\nif (meal.cooking_method === 'cook4me') {\n    const instructions = meal.instructions || [];\n    const instructionText = instructions.map(i => i.instruction || i).join(' ');\n    \n    // Check for required phrase\n    const hasPressureTime = /Pressure cooking time = \\d+ min/i.test(instructionText);\n    if (!hasPressureTime) {\n        errors.push('Missing required \"Pressure cooking time = X min\" instruction');\n    }\n    \n    // Check for lid instructions\n    const hasCloseLid = /close.*lid/i.test(instructionText);\n    if (!hasCloseLid) {\n        warnings.push('Missing \"close and lock the lid\" instruction');\n    }\n    \n    // Check for minimum liquid\n    const hasLiquid = meal.ingredients.some(i => {\n        return (i.unit === 'ml' && i.quantity >= 200) || \n               (i.item && /water|stock|broth/i.test(i.item) && i.quantity >= 200);\n    });\n    \n    if (!hasLiquid) {\n        errors.push('Missing minimum 200ml liquid (required for pressure cooking)');\n    }\n}\n\n// Ingredient validation\nif (meal.ingredients && meal.ingredients.length > 0) {\n    meal.ingredients.forEach((ing, index) => {\n        if (!ing.calories) {\n            warnings.push(`Ingredient ${index + 1} (${ing.item}) missing calorie data`);\n        }\n        if (!ing.protein_g && ing.protein_g !== 0) {\n            warnings.push(`Ingredient ${index + 1} (${ing.item}) missing protein data`);\n        }\n    });\n}\n\nconst validationResult = {\n    valid: errors.length === 0,\n    critical_failures: errors.length,\n    warnings: warnings.length,\n    errors: errors,\n    warnings: warnings,\n    validated_at: new Date().toISOString()\n};\n\n// If critical failures, throw error to trigger regeneration\nif (!validationResult.valid) {\n    throw new Error(`Meal validation failed:\\n${errors.join('\\n')}`);\n}\n\nreturn [{\n    json: {\n        ...$json,\n        validation: validationResult,\n        meal_validated: true\n    }\n}];"
      },
      "id": "78901234-5678-9012-3456-789012345678",
      "name": "Validate Meal",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1780,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Cache the generated meal for 24 hours\n// This saves costs on repeated similar requests\n\nconst meal = $json.meal;\nconst cacheKey = $json.cache_key;\nconst TTL_SECONDS = 86400; // 24 hours\n\n// In production: await $redis.setex(cacheKey, TTL_SECONDS, JSON.stringify(meal))\n\nreturn [{\n    json: {\n        ...$json,\n        meal_cached: true,\n        cache_ttl: TTL_SECONDS,\n        cache_expires_at: new Date(Date.now() + TTL_SECONDS * 1000).toISOString()\n    }\n}];"
      },
      "id": "89012345-6789-0123-4567-890123456789",
      "name": "Cache Meal",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Format meal for Telegram display\nconst meal = $json.meal;\nconst usage = $json.usage;\nconst validation = $json.validation;\n\n// Escape special characters for MarkdownV2\nfunction escapeMarkdown(text) {\n    return text.replace(/[_*\\[\\]()~`>#+=|{}.!-]/g, '\\\\$&');\n}\n\n// Build response message\nlet message = `ðŸ½ï¸ *${escapeMarkdown(meal.meal_name)}*\\n\\n`;\nmessage += `${escapeMarkdown(meal.description)}\\n\\n`;\n\n// Timing\nmessage += `â±ï¸ *Time*\\n`;\nmessage += `â€¢ Prep: ${meal.prep_time_minutes} min\\n`;\nmessage += `â€¢ Cook: ${meal.cook_time_minutes} min\\n`;\nmessage += `â€¢ Total: ${meal.prep_time_minutes + meal.cook_time_minutes} min\\n\\n`;\n\n// Nutrition\nconst nutrition = meal.nutritional_summary;\nmessage += `ðŸ“Š *Nutrition*\\n`;\nmessage += `â€¢ Calories: ${nutrition.total_calories} kcal\\n`;\nmessage += `â€¢ Protein: ${nutrition.total_protein_g}g\\n`;\nmessage += `â€¢ Carbs: ${nutrition.total_carbs_g}g\\n`;\nmessage += `â€¢ Fat: ${nutrition.total_fat_g}g\\n`;\nif (nutrition.total_fiber_g) {\n    message += `â€¢ Fiber: ${nutrition.total_fiber_g}g\\n`;\n}\nmessage += `\\n`;\n\n// Ingredients summary\nmessage += `ðŸ›’ *Ingredients* \\(${meal.ingredients.length}\\)\\n`;\nmeal.ingredients.slice(0, 5).forEach(ing => {\n    message += `â€¢ ${ing.quantity}${ing.unit} ${escapeMarkdown(ing.item)}\\n`;\n});\nif (meal.ingredients.length > 5) {\n    message += `â€¢ \\.\\.\\. and ${meal.ingredients.length - 5} more\\n`;\n}\nmessage += `\\n`;\n\n// Instructions summary\nmessage += `ðŸ‘¨â€ðŸ³ *Instructions* \\(${meal.instructions.length} steps\\)\\n`;\nmessage += `_Full recipe with detailed instructions available\\._\\n\\n`;\n\n// Cooking method\nconst methodIcon = meal.cooking_method === 'cook4me' ? 'ðŸ²' : 'ðŸ‘¨â€ðŸ³';\nmessage += `${methodIcon} *${meal.cooking_method === 'cook4me' ? 'Cook4me' : 'Traditional'}* cooking method\\n\\n`;\n\n// Warnings if any\nif (validation.warnings && validation.warnings.length > 0) {\n    message += `âš ï¸ _Note: ${escapeMarkdown(validation.warnings[0])}_\\n\\n`;\n}\n\n// Footer\nif ($json.cache_hit) {\n    message += `âœ¨ _Curated meal from your preferences_`;\n} else {\n    message += `ðŸ¤– _AI\\\\-generated meal \\\\| Cost: \\\\$${usage.total_cost_usd.toFixed(4)}_`;\n}\n\nreturn [{\n    json: {\n        response_message: message,\n        parse_mode: 'MarkdownV2',\n        meal: meal,\n        usage: usage\n    }\n}];"
      },
      "id": "90123456-7890-1234-5678-901234567890",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2220,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Return formatted response\nreturn [{\n    json: {\n        response_message: $json.response_message,\n        parse_mode: $json.parse_mode,\n        meal: $json.meal,\n        usage: $json.usage || { total_cost_usd: 0 },\n        workflow_completed: true,\n        completed_at: new Date().toISOString()\n    }\n}];"
      },
      "id": "01234567-8901-2345-6789-012345678901",
      "name": "Return Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2440,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Return cached meal directly\nconst meal = $json.meal;\n\n// Format for display\nfunction escapeMarkdown(text) {\n    return text.replace(/[_*\\[\\]()~`>#+=|{}.!-]/g, '\\\\$&');\n}\n\nlet message = `âœ¨ *${escapeMarkdown(meal.meal_name)}*\\n\\n`;\nmessage += `${escapeMarkdown(meal.description)}\\n\\n`;\nmessage += `ðŸ“Š *Nutrition*\\n`;\nmessage += `â€¢ ${meal.nutritional_summary.total_calories} kcal\\n`;\nmessage += `â€¢ ${meal.nutritional_summary.total_protein_g}g protein\\n\\n`;\nmessage += `_Curated meal from your preferences \\\\(cached\\\\)_`;\n\nreturn [{\n    json: {\n        response_message: message,\n        parse_mode: 'MarkdownV2',\n        meal: meal,\n        usage: { total_cost_usd: 0 },\n        cache_hit: true,\n        workflow_completed: true,\n        completed_at: new Date().toISOString()\n    }\n}];"
      },
      "id": "12345678-9012-3456-7890-123456789012",
      "name": "Return Cached Meal",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        400
      ]
    }
  ],
  "connections": {
    "Workflow Input": {
      "main": [
        [
          {
            "node": "Validate Inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Inputs": {
      "main": [
        [
          {
            "node": "Check Meal Cache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Meal Cache": {
      "main": [
        [
          {
            "node": "Is Cache Hit?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Cache Hit?": {
      "main": [
        [
          {
            "node": "Return Cached Meal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build AI Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build AI Prompt": {
      "main": [
        [
          {
            "node": "Call Anthropic API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Anthropic API": {
      "main": [
        [
          {
            "node": "Parse AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Response": {
      "main": [
        [
          {
            "node": "Validate Meal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Meal": {
      "main": [
        [
          {
            "node": "Cache Meal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cache Meal": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Return Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-01-15T00:00:00.000Z",
      "updatedAt": "2025-01-15T00:00:00.000Z",
      "id": "1",
      "name": "production"
    },
    {
      "createdAt": "2025-01-15T00:00:00.000Z",
      "updatedAt": "2025-01-15T00:00:00.000Z",
      "id": "2",
      "name": "meal-planner"
    },
    {
      "createdAt": "2025-01-15T00:00:00.000Z",
      "updatedAt": "2025-01-15T00:00:00.000Z",
      "id": "3",
      "name": "sub-workflow"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-01-15T00:00:00.000Z",
  "versionId": "1.0.0",
  "meta": {
    "templateCredsSetupCompleted": false,
    "instanceId": "your-n8n-instance-id"
  }
}
